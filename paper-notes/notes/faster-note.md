# Fast-note
## 1. 核心工具 - FindIntersection 算法 (算法2)

`FindIntersection` 是FASTER框架中一个底层但至关重要的几何计算模块，其作用是高效地寻找一条分段线性路径与一个三维体素网格（Voxel Grid）的第一个交点。 

### 算法目标
判断一个点集 `JPSk`（代表路径）和另一个空间 `U`（代表障碍物或未知区域）是否存在“相交”。如果路径上的点 `V` 与空间中的最近邻点 `N` 之间的距离小于阈值 `ε`，则返回交点；否则通过迭代搜索找到路径与空间的边界交点。

### 在 FASTER 中的具体应用
它作为“边界与碰撞检测工具”，主要用于三个场景：

1.  **计算与新障碍物的碰撞点**: 当感知到新障碍物`O`时，调用此算法计算旧路径`JPSk-1`与`O`的交点，以确定路径失效的起点。
2.  **确定安全轨迹的终点**: 计算“完整轨迹`(Whole)`”与“未知空间`(U)`”的第一个交点`H`。`H`点是已知世界的尽头，是后续规划“安全轨迹`(Safe)`”的关键参考点。
3.  **引导无人机主动感知**: 计算当前JPS路径与未知空间`U`的交点，并将无人机的相机朝向该点，以最大化地获取前方环境信息，提前发现危险。

---

## 2. 主框架 - FASTER 重规划算法 (算法1)

这是论文的核心，描述了无人机在飞行中的主规划循环函数 `Replan()`。每一次调用都代表一次完整的重规划。

### 总体概览
整个算法可分为三个主要阶段：
1.  **阶段一：确定规划方向 (Lines 2-17)** - 利用轻量级的JPS算法，快速确定一个几何最优的大致方向。
2.  **阶段二：生成双轨迹 (Lines 18-27)** - 算法的精髓所在，生成一条追求速度的“激进”轨迹和一条保障安全的“保守”轨迹。
3.  **阶段三：整合与提交 (Line 28-31)** - 将两条轨迹无缝拼接，形成最终可执行的安全指令。

### 阶段一：确定规划方向
- **起点A**: 规划的起点不是无人机当前位置`L`，而是沿上次轨迹向前推进一小段距离`δt`的点，以保证平滑过渡。
- **乐观的JPS路径**: 算法首先运行JPS，寻找从`A`到临时目标`G`的路径`JPSa`。在这一步，**未知区域`U`被乐观地视作可通过的自由空间**。
- **决策与选择**: 算法会比较新路径`JPSa`和旧路径`JPSk-1`的方向。
    - 如果方向**偏离较大**，说明环境变化剧烈，算法会同时考虑`JPSa`和一条修复后的旧路径`JPSb`，选择预估成本更低的一条作为引导路径`JPSk`。
    - 如果方向**偏离不大**，则直接采纳新的`JPSa`。

### 阶段二：生成双轨迹
这是FASTER实现“又快又安全”的核心机制。

1.  **`Whole` 轨迹 (激进探索)**
    - **飞行走廊 `PolyWhole`**: 沿着引导路径`JPSk`，在**已知自由空间`F`和未知空间`U` (`F ∪ U`)** 中构建一个由凸多面体组成的通道。允许进入`U`是其能够高速规划的关键。
    - **轨迹生成**: 在`PolyWhole`内求解一个MIQP（混合整数二次规划）问题，生成一条从`A`到临时终点`E`的、满足动力学约束的、**高速平滑**的轨迹。

2.  **`Safe` 轨迹 (绝对安全)**
    - **安全边界**: 首先，利用`FindIntersection`找到`Whole`轨迹进入未知空间`U`的临界点`H`，并在此之前确定一个有足够制动距离的**安全决策点`R`**。
    - **飞行走廊 `PolySafe`**: **只在100%安全的已知自由空间`F`**中构建另一个凸多面体通道。
    - **轨迹生成**: 在`PolySafe`内求解MIQP，生成一条从`R`点开始的、最终能安全停止（如悬停）的**绝对安全**的备用轨迹。

### 阶段三：整合与提交
- **`Committedk ← WholeA→R ∪ Safe`**: 这是算法的点睛之笔。最终提交给无人机执行的指令`Committedk`由两部分无缝拼接而成：
    1. `Whole`轨迹的前半段（从`A`到`R`的高速飞行部分）。
    2. 完整的`Safe`轨迹（从`R`开始的安全制动/悬停部分）。
- **核心保障**: 这种设计确保了无人机总是在执行一条**“前半段追求速度，后半段自带安全预案”**的轨迹。即使下一轮规划失败，无人机也能依靠当前`Committed`轨迹的后半段安全停止。

---

## 3. 关键概念与实现细节 Q&A

#### Q1: 局部地图`M`、已知`F`、障碍`O`和未知`U`的关系？
- **局部地图`M`**是无人机当前的“世界观”，是一个随自身移动的有限空间。
- `M`内部被划分为三部分：已确认可通过的`F`，已确认有障碍的`O`，以及传感器还未扫描到的`U`。即 `M = F ∪ O ∪ U_local`。
- FASTER的创新在于它敢于利用`M`中的`U`进行乐观规划，而不是像传统算法那样只在`F`中飞行。

#### Q2: 目标点`E`是什么？是最终终点吗？
- `E`是当前**局部规划**的**临时目标状态**，在绝大多数情况下**不是**整个任务的最终终点。
- **位置**: `E`的位置由最终任务目标`G_term`在当前局部地图`M`上的投影`G`决定。它像一个不断在前方移动的“诱饵”。
- **状态**: `E`是一个带有**“最终停止条件 (final stop condition)”**的状态，即其目标速度和加速度均为**零**。这为MIQP优化提供了明确的边界条件，并保证了每段局部轨迹的完整性。

#### Q3: 轨迹的时间因子`f`和搜索区间有什么意义？(第20/26行)
- `f`是一个时间缩放因子，`f`越小，分配给每段轨迹的时间`dt`越少，轨迹速度越快，但求解也越困难。
- 算法不直接优化`dt`（计算成本太高），而是采用**启发式线性搜索**：
    1.  **借鉴历史**: 以上一轮规划成功的因子`f,k-1`为基准。
    2.  **局部搜索**: 在基准附近设定一个小的搜索区间 `[f,k-1 - γ, f,k-1 + γ']`。
    3.  **贪心尝试**: 从区间内最小（最快）的`f`值开始尝试求解MIQP，如果失败则逐步增大`f`（降低速度要求），直到找到解。
- 这个机制极大地提高了求解效率，是保证算法实时性的关键。

#### Q4: 每一小段多项式轨迹的`dt`都一样吗？
- **是的**。在FASTER的这个实现中，为了**简化优化问题、保证实时性**，同一条轨迹（`Whole`或`Safe`）被划分为N个多项式小段，并且分配给每一段的时间`dt`都是相同的。
- 这是典型的工程权衡：牺牲了轨迹的**理论最优性**（真正最优的轨迹在不同路段速度应不同），换取了**规划速度**和**问题的可解性**。在未知环境中，后者远比前者重要。

#### Q5: 飞行中，无人机如何得到每个时刻的速度和加速度？
规划的输出（`Committedk`轨迹）是一组**分段三次多项式函数的系数**。
- **位置函数**: `x(t) = at³ + bt² + ct + d`
- **执行过程**:
    1.  无人机的**轨迹跟踪控制器**在高频循环。
    2.  在每个时刻`t`，控制器对位置函数**求一次导数得到理想速度`v(t)`**，**求二次导数得到理想加速度`a(t)`**。
    3.  控制器测量无人机当前真实状态，计算与理想状态的误差。
    4.  根据误差，控制器计算并向电机下达指令，从而精确地“跟踪”这条由数学函数定义的时空轨迹。