# Fast-Planner 与 EGO-Planner 核心技术对比分析

## 概述

本文档详细总结了两种先进的四旋翼无人机实时轨迹规划器：**Fast-Planner** (`Robust and Efficient Quadrotor Trajectory Generation...`) 和 **EGO-Planner** (`An ESDF-Free Gradient-Based Local Planner...`) 在核心实现、地图使用和规划策略上的异同。

总体而言，这两种规划器都采用了“前端搜索 + 后端优化”的二级框架，旨在复杂环境中生成平滑、安全且动力学可行的飞行轨迹。**EGO-Planner可以看作是Fast-Planner技术路线的一种演进，其核心创新在于摆脱了对欧几里得距离场（ESDF）的依赖，从而显著提升了计算效率。**

---

## 核心相同点

尽管实现细节不同，但两者在底层设计哲学上有诸多共通之处：

1.  **二级规划框架**：都采用混合规划思路。前端负责快速找到一条粗略的初始路径，后端在此基础上进行非线性优化，生成最终的高质量轨迹。
2.  **B样条轨迹表达**：都选择**B样条 (B-spline)** 作为轨迹的数学表达形式，以利用其优秀的局部可控性、自带的平滑性以及凸包特性。
3.  **多目标优化**：后端的优化目标函数都包含了三个关键部分：
    *   **平滑度 (Smoothness)**：最小化轨迹的加速度或加加速度（jerk）。
    *   **安全性 (Safety)**：与障碍物保持安全距离。
    *   **动力学可行性 (Feasibility)**：确保轨迹的速度、加速度等在无人机物理极限内。
4.  **利用凸包特性**：都巧妙地利用B样条的**凸包特性 (Convex Hull Property)** 来简化动力学约束。通过仅约束B样条的控制点，就能有效约束整段轨迹，极大提高了优化效率。

---

## 核心不同点：一场关于“地图信息利用”的革命

两者最根本的区别在于**如何感知和利用环境中的障碍物信息**，这导致了它们在实现流程上的巨大差异。

| 对比维度 | 论文A: Fast-Planner (依赖ESDF) | 论文B: EGO-Planner (摆脱ESDF) |
| :--- | :--- | :--- |
| **核心思想** | **依赖预计算的ESDF梯度信息**来“推”开轨迹，进行避障优化。 | **摆脱ESDF**，通过**在线、按需**生成碰撞点信息来直接计算避障梯度。 |
| **前端路径搜索** | 采用**混合A\* (Hybrid A\*)** 进行**动力学路径搜索 (Kinodynamic Path Searching)**。能直接生成一条满足动力学约束的初始轨迹。 | 前端较为灵活，但通常需要一个**无碰撞的初始路径**（如A\*搜索结果）来为后端优化提供良好的初始值。 |
| **障碍物信息处理** | **强依赖ESDF地图**。需要将传感器感知的局部地图预处理成ESDF，优化器通过查询该场来获取任意点的距离和梯度。 | **完全不使用ESDF**。直接在原始地图（如栅格图）上进行碰撞检测。**只在轨迹与障碍物碰撞时**，才动态生成**锚点 (Anchor Point)** 和**排斥向量 (Repulsive Vector)**。 |
| **碰撞代价函数** | 基于从ESDF中查询到的**距离值**构建。当距离小于安全阈值时，产生一个排斥力。 | 基于控制点与其对应**锚点**的距离和方向构建。只在必要时计算，避免了为整个空间计算距离场的开销。 |
| **时间重分配策略** | **迭代式时间调整 (Iterative Time Adjustment)**。优化后若轨迹不满足动力学约束，通过迭代地**拉长非均匀B样条的节点向量 (Knot Spans)**来放宽时间。 | **时间重分配与各向异性曲线拟合 (Time Re-allocation & Anisotropic Curve Fitting)**。一次性根据超速比例计算出新的总时间，然后通过一个考虑形状保持的拟合算法，生成一条全新的、满足所有约束的轨迹。 |
| **计算效率与瓶颈** | 主要计算瓶颈在于**ESDF的构建和维护**，尤其是在动态环境中，这部分占据了大量计算资源。 | **计算效率极高**。由于避免了ESDF的冗余计算，只关注与轨迹直接相关的障碍物信息，规划时间显著缩短。 |
| **鲁棒性** | 可能会因ESDF梯度陷入**局部最优**（如U型陷阱）。 | 通过动态生成引导路径和锚点，为轨迹提供了更明确的逃逸方向，在一定程度上缓解了局部最优问题。 |

---

## 关键问题一：是否需要全局地图？

**结论：两者都不强制要求一个预先构建好的全局地图，但都必须依赖一个由传感器实时构建的局部地图来工作。**

*   **Fast-Planner**：它的混合A\*前端需要在**局部栅格地图**中进行搜索以判断路径是否安全。然后，这个局部地图会被转换成**局部ESDF地图**，供后端优化器使用。
*   **EGO-Planner**：它同样需要在**局部栅格地图**上进行碰撞检测和前端路径搜索。它的优势在于**跳过了生成ESDF的步骤**，直接与原始局部地图交互，从而提高了效率。

它们都是为未知环境设计的**局部规划器**，在一个有限的、由传感器感知的“视野”内工作。

---

## 关键问题二：目标点在局部地图之外怎么办？

当最终目标点远在传感器范围之外时，规划器采用一种名为 **“平移窗口” (Receding Horizon) 的规划策略**，逐步逼近目标。

这个过程好比在漆黑的夜晚开车，你只能看见车灯照亮的前方一小段路（**局部地图**），但你知道最终目标的方向。

### 具体实现流程：

1.  **确定临时目标点 (Intermediate Goal)**
    *   规划器在当前**局部地图的边界上**，选择一个最接近最终目标方向的点，作为本次规划的**临时目标点**。这是它当前“视野”的尽头。

2.  **执行局部规划**
    *   规划器倾尽全力，在当前已知的局部地图内，规划出一条从当前位置飞向该**临时目标点**的最佳轨迹。

3.  **执行一小段并更新地图**
    *   无人机并不会飞完整条轨迹，通常只执行其中的一小部分（例如未来1-2秒的路径）。
    *   在飞行的同时，传感器不断感知新环境，**局部地图也随之向前“平移”和更新**。

4.  **循环往复**
    *   无人机在一个新的位置，面对一张新的局部地图，再次重复第1步，确定一个新的临时目标点，然后再次规划。

这个 **“确定临时目标 -> 局部规划 -> 执行一小段 -> 更新地图”** 的循环会一直持续，直到最终目标点进入了无人机的感知范围，此时规划器便可完成“最后一跃”。

### 特殊情况：陷入“死胡同”怎么办？

如果无人机被引导进一个U型陷阱，局部规划器会因为找不到通往临时目标点的路径而**规划失败**。此时，系统需要更高层级的决策：
*   **简单策略**：尝试后退或向其他方向探索。
*   **高级策略**：依赖一个**全局规划器**（运行在低精度地图上）或拓扑地图来提供一个逃逸的宏观路径点（例如“先飞回走廊入口”），然后局部规划器再执行这个新的宏观指令。